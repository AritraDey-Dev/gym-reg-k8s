---
name: Validation CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  lint-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Install yamllint
      - name: Install yamllint
        run: |
          python3 -m pip install --upgrade pip
          pip install yamllint

      # Lint all YAML files
      - name: Run yamllint on all *.yaml files using relaxed config
        run: |
          yamllint -c .yamllint -s $(git ls-files "*.yaml" "*.yml")

      # Install kubeconform
      - name: Install kubeconform
        run: |
          mkdir -p $HOME/.local/bin
          curl -sSL https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz | tar xz -C $HOME/.local/bin
          chmod +x $HOME/.local/bin/kubeconform
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # Validate manifests with kubeconform
      - name: Run kubeconform on all manifests
        run: |
          kubeconform -ignore-filename-pattern '.github/workflows/.*' -ignore-missing-schemas -summary $(git ls-files "*.yaml" "*.yml")

      # Install kube-score
      - name: Install kube-score
        run: |
          mkdir -p $HOME/.local/bin
          curl -sSL https://github.com/zegl/kube-score/releases/download/v1.19.0/kube-score_1.19.0_linux_amd64.tar.gz | tar xz -C $HOME/.local/bin
          chmod +x $HOME/.local/bin/kube-score
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # Run kube-score on all manifests (informational only, won't fail the build)
      - name: Run kube-score on all manifests
        continue-on-error: true
        run: |
          for f in $(git ls-files "*.yaml" "*.yml"); do
            # Skip non-Kubernetes manifests
            if [[ "$f" == .github/workflows/* ]]; then
              continue
            fi
            kube-score score "$f" || true
          done

      # # Helm lint (if a Helm chart exists)
      # - name: Helm lint (optional)
      #   if: exists('Chart.yaml')
      #   run: |
      #     helm lint .
